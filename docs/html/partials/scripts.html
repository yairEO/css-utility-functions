<script>
  (function() {
    'use strict';

    // Constants
    const SCROLL_OFFSET = 200;
    const THROTTLE_DELAY = 100;

    // Cache DOM elements
    const sections = Array.from(document.querySelectorAll('.function-section'));
    const sidebar = document.querySelector('.sidebar');
    const sidebarLinks = Array.from(document.querySelectorAll('.sidebar nav a[data-function]'));
    const anchorLinks = document.querySelectorAll('a[href^="#"]');
    const demos = document.querySelectorAll('[data-demo]');

    // Create link map for O(1) lookup
    const linkMap = new Map();
    sidebarLinks.forEach(link => {
      const href = link.getAttribute('href');
      if (href) {
        linkMap.set(href.slice(1), link);
      }
    });

    // Throttle utility
    function throttle(func, delay) {
      let timeoutId;
      let lastExecTime = 0;
      return function(...args) {
        const currentTime = Date.now();
        if (currentTime - lastExecTime > delay) {
          func.apply(this, args);
          lastExecTime = currentTime;
        } else {
          clearTimeout(timeoutId);
          timeoutId = setTimeout(() => {
            func.apply(this, args);
            lastExecTime = Date.now();
          }, delay - (currentTime - lastExecTime));
        }
      };
    }

    // Check if element is visible in viewport
    function isElementVisible(element, container) {
      const elementRect = element.getBoundingClientRect();
      const containerRect = container.getBoundingClientRect();
      return elementRect.top >= containerRect.top && elementRect.bottom <= containerRect.bottom;
    }

    // Scroll sidebar to show active link
    function scrollToActiveLink(link) {
      if (!sidebar || !link) return;

      if (!isElementVisible(link, sidebar)) {
        link.scrollIntoView({
          behavior: 'smooth',
          block: 'center',
          inline: 'nearest'
        });
      }
    }

    // Update active sidebar link based on scroll position
    function updateActiveLink() {
      const scrollPos = window.scrollY + SCROLL_OFFSET;
      let currentActiveLink = null;

      // Find active section using early exit
      for (const section of sections) {
        const top = section.offsetTop;
        const bottom = top + section.offsetHeight;
        const id = section.id;

        if (scrollPos >= top && scrollPos < bottom) {
          const link = linkMap.get(id);
          if (link) {
            currentActiveLink = link;
          }
          break;
        }
      }

      // Update active state efficiently
      if (currentActiveLink) {
        const wasAlreadyActive = currentActiveLink.classList.contains('active');

        if (!wasAlreadyActive) {
          sidebarLinks.forEach(link => link.classList.remove('active'));
          currentActiveLink.classList.add('active');
          scrollToActiveLink(currentActiveLink);
        }
      }
    }

    // Smooth scroll handler for anchor links
    function handleAnchorClick(e) {
      const href = this.getAttribute('href');
      if (!href || href === '#') return;

      e.preventDefault();
      const target = document.querySelector(href);
      if (target) {
        target.scrollIntoView({
          behavior: 'smooth',
          block: 'start'
        });
      }
    }

    // Demo handlers registry
    const demoHandlers = {
      alpha(demo) {
        const slider = demo.querySelector('input[type="range"]');
        const colorInput = demo.querySelector('input[type="color"]');
        const box = demo.querySelector('.color-demo');
        const valueDisplay = demo.querySelector('.value-display');

        if (!slider || !colorInput || !box || !valueDisplay) return;

        const updateAlpha = () => {
          const opacity = slider.value;
          const color = colorInput.value;
          box.style.backgroundColor = `oklch(from ${color} l c h / ${opacity})`;
          valueDisplay.textContent = `Opacity: ${opacity}`;
        };

        slider.addEventListener('input', updateAlpha);
        colorInput.addEventListener('input', updateAlpha);
        updateAlpha();
      }
    };

    // Initialize demos
    demos.forEach(demo => {
      const type = demo.getAttribute('data-demo');
      const handler = demoHandlers[type];
      if (handler) {
        handler(demo);
      }
    });

    // Initialize event listeners
    window.addEventListener('scroll', throttle(updateActiveLink, THROTTLE_DELAY));
    window.addEventListener('load', updateActiveLink);
    anchorLinks.forEach(anchor => anchor.addEventListener('click', handleAnchorClick));
  })();
</script>
